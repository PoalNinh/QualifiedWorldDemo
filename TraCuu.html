<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tìm Visa Phù Hợp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step-transition {
            transition: all 0.5s ease-in-out;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.5s ease-in-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Thêm hiệu ứng ripple cho nút */
        .btn-ripple {
            position: relative;
            overflow: hidden;
        }

        .btn-ripple:after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }

        .btn-ripple:active:after {
            transform: scale(0, 0);
            opacity: .3;
            transition: 0s;
        }

        /* Làm mượt các chuyển đổi */
        * {
            transition: background-color 0.3s, box-shadow 0.3s, transform 0.2s;
        }

        /* Card hover effect */
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Chi tiết content */
        .content-hidden {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }

        .content-visible {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.4);
        }

        .progress-circle {
            position: relative;
            width: 60px;
            height: 60px;
        }

        .progress-circle svg {
            transform: rotate(-90deg);
        }

        .progress-circle circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            stroke-linecap: round;
            stroke-width: 6px;
            fill: none;
            transition: stroke-dashoffset 0.5s ease;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-xl shadow-xl p-6 max-w-4xl mx-auto border border-gray-100">
            <h1 class="text-2xl md:text-3xl font-bold text-center text-blue-800 mb-6">Tìm Loại Visa Phù Hợp Nhất</h1>

            <div id="loading" class="text-center py-10">
                <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-4 border-b-4 border-blue-600">
                </div>
                <p class="mt-4 text-gray-600 font-medium">Đang tải dữ liệu...</p>
            </div>

            <!-- Progress Bar -->
            <div id="progressContainer" class="mb-8 hidden">
                <div class="flex justify-between mb-2">
                    <span id="progressText" class="text-sm font-medium text-blue-700">Bước 1/4</span>
                    <span id="progressPercentage" class="text-sm font-medium text-blue-700">25%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-500"
                        style="width: 25%"></div>
                </div>
            </div>

            <form id="visaForm" class="hidden">
                <!-- Step 1: Thông tin cá nhân -->
                <div id="step1" class="step-transition fade-in">
                    <div class="border-b pb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-5">Thông tin cá nhân</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Họ và
                                    tên</label>
                                <input type="text" id="fullName" name="fullName"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Tuổi <span
                                        class="text-red-500">*</span></label>
                                <input type="number" id="age" name="age" min="1" max="100" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="email" name="email"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <p class="mt-1 text-xs text-gray-500">Nhập email hoặc số điện thoại</p>
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Số điện
                                    thoại</label>
                                <input type="tel" id="phone" name="phone"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <p class="mt-1 text-xs text-gray-500">Nhập email hoặc số điện thoại</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="button" id="nextStep1"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 btn-ripple">
                            Tiếp theo
                        </button>
                    </div>
                </div>

                <!-- Step 2: Thông tin tài chính và ngôn ngữ -->
                <div id="step2" class="hidden step-transition">
                    <div class="border-b pb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-5">Thông tin tài chính và ngôn ngữ</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label for="finance" class="block text-sm font-medium text-gray-700 mb-1">Tài chính
                                    (VNĐ/năm) <span class="text-red-500">*</span></label>
                                <input type="number" id="finance" name="finance" min="0" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="englishScore" class="block text-sm font-medium text-gray-700 mb-1">Điểm
                                    tiếng Anh (TOEFL/IELTS...) <span class="text-red-500">*</span></label>
                                <input type="number" id="englishScore" name="englishScore" min="0" max="120" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-between">
                        <button type="button" id="prevStep2"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-3 px-6 rounded-lg transition duration-300 ease-in-out btn-ripple">
                            Quay lại
                        </button>
                        <button type="button" id="nextStep2"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 btn-ripple">
                            Tiếp theo
                        </button>
                    </div>
                </div>

                <!-- Step 3: Thông tin du học -->
                <div id="step3" class="hidden step-transition">
                    <div class="border-b pb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-5">Thông tin du học</h2>
                        <div class="space-y-5">
                            <div>
                                <label for="visaType" class="block text-sm font-medium text-gray-700 mb-1">Loại visa
                                    mong muốn <span class="text-red-500">*</span></label>
                                <select id="visaType" name="visaType" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                    <option value="">-- Chọn loại visa --</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div>
                                <label for="country" class="block text-sm font-medium text-gray-700 mb-1">Quốc gia mong
                                    muốn <span class="text-red-500">*</span></label>
                                <select id="country" name="country" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                    <option value="">-- Chọn quốc gia --</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-between">
                        <button type="button" id="prevStep3"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-3 px-6 rounded-lg transition duration-300 ease-in-out btn-ripple">
                            Quay lại
                        </button>
                        <button type="button" id="nextStep3"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 btn-ripple">
                            Tiếp theo
                        </button>
                    </div>
                </div>

                <!-- Step 4: Xác nhận -->
                <div id="step4" class="hidden step-transition">
                    <div class="border-b pb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-5">Xác nhận thông tin</h2>
                        <div class="bg-gray-50 p-5 rounded-lg border border-gray-200">
                            <h3 class="font-medium text-gray-800 mb-3">Thông tin cá nhân</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                <p class="text-sm text-gray-700"><span class="font-medium">Họ tên:</span> <span
                                        id="summaryName" class="text-gray-800"></span></p>
                                <p class="text-sm text-gray-700"><span class="font-medium">Tuổi:</span> <span
                                        id="summaryAge" class="text-gray-800"></span></p>
                                <p class="text-sm text-gray-700"><span class="font-medium">Email:</span> <span
                                        id="summaryEmail" class="text-gray-800"></span></p>
                                <p class="text-sm text-gray-700"><span class="font-medium">Số điện thoại:</span> <span
                                        id="summaryPhone" class="text-gray-800"></span></p>
                            </div>

                            <h3 class="font-medium text-gray-800 mb-3">Thông tin tài chính và ngôn ngữ</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                <p class="text-sm text-gray-700"><span class="font-medium">Tài chính:</span> <span
                                        id="summaryFinance" class="text-gray-800"></span> VNĐ/năm</p>
                                <p class="text-sm text-gray-700"><span class="font-medium">Điểm tiếng Anh:</span> <span
                                        id="summaryEnglish" class="text-gray-800"></span></p>
                            </div>

                            <h3 class="font-medium text-gray-800 mb-3">Thông tin du học</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <p class="text-sm text-gray-700"><span class="font-medium">Loại visa:</span> <span
                                        id="summaryVisaType" class="text-gray-800"></span></p>
                                <p class="text-sm text-gray-700"><span class="font-medium">Quốc gia:</span> <span
                                        id="summaryCountry" class="text-gray-800"></span></p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-between">
                        <button type="button" id="prevStep4"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-3 px-6 rounded-lg transition duration-300 ease-in-out btn-ripple">
                            Quay lại
                        </button>
                        <button type="submit"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 btn-ripple">
                            Tìm Visa Phù Hợp
                        </button>
                    </div>
                </div>
            </form>

            <!-- Kết quả tìm kiếm -->
            <div id="results" class="mt-8 hidden fade-in">
                <h2 class="text-xl font-semibold text-green-700 mb-5">Visa phù hợp cho bạn</h2>
                <div id="visaResults" class="space-y-6">
                    <!-- Kết quả sẽ được hiển thị ở đây -->
                </div>
            </div>

            <!-- Thông báo lỗi khi không thể lấy dữ liệu -->
            <div id="errorMessage" class="hidden mt-8 p-5 bg-red-100 border border-red-300 text-red-700 rounded-lg">
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <p>Không thể kết nối đến máy chủ. Vui lòng thử lại sau.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Lưu trữ dữ liệu visa toàn cục
        let allVisaData = [];

        // Theo dõi bước hiện tại
        let currentStep = 1;
        const totalSteps = 4;

        // Hàm để cập nhật thanh tiến trình
        function updateProgressBar(step) {
            const percentage = (step / totalSteps) * 100;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `Bước ${step}/${totalSteps}`;
            document.getElementById('progressPercentage').textContent = `${percentage}%`;
        }

        // Hàm để hiển thị bước cụ thể
        function showStep(step) {
            // Ẩn tất cả các bước
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }

            // Hiển thị bước cụ thể
            const stepElement = document.getElementById(`step${step}`);
            stepElement.classList.remove('hidden');

            // Thêm hiệu ứng fade-in
            stepElement.classList.add('fade-in');

            // Cập nhật thanh tiến trình
            updateProgressBar(step);

            // Cập nhật step hiện tại
            currentStep = step;
        }

        // Hàm toggle chi tiết
        function toggleDetails(visaId) {
            const detailsContent = document.getElementById(`details-content-${visaId}`);
            const detailsBtn = document.getElementById(`details-btn-${visaId}`);

            if (detailsContent.classList.contains('content-hidden')) {
                detailsContent.classList.remove('content-hidden');
                detailsContent.classList.add('content-visible');
                detailsBtn.textContent = 'Ẩn chi tiết';
                detailsBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                detailsBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
            } else {
                detailsContent.classList.remove('content-visible');
                detailsContent.classList.add('content-hidden');
                detailsBtn.textContent = 'Xem chi tiết';
                detailsBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                detailsBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        }

        // Tìm visa phù hợp với khoảng linh hoạt
        function findSuitableVisas(age, finance, englishScore, visaType, country) {
            // Trước tiên tìm visa phù hợp chính xác
            const exactMatches = allVisaData.filter(visa => {
                // Kiểm tra loại visa
                if (visaType && visa["LOẠI VISA"] !== visaType) return false;

                // Kiểm tra quốc gia
                if (country && visa["NƯỚC DU HỌC"] !== country) return false;

                // Kiểm tra độ tuổi
                const ageRanges = visa["ĐỘ TUỔI PHÙ HỢP"]?.split(',').map(a => parseInt(a.trim())) || [];
                if (ageRanges.length > 0 && !ageRanges.includes(age)) return false;

                // Kiểm tra tài chính
                const minFinance = parseInt(visa["TÀI CHÍNH PHÙ HỢP TRÊN NĂM"] || 0);
                if (finance < minFinance) return false;

                // Kiểm tra điểm tiếng Anh
                const minEnglishScore = parseInt(visa["ĐIỂM TIẾNG ANH"] || 0);
                if (englishScore < minEnglishScore) return false;

                return true;
            });

            // Nếu có kết quả chính xác, trả về ngay
            if (exactMatches.length > 0) {
                return exactMatches;
            }

            // Nếu không có kết quả chính xác, tìm kết quả gần giống nhất
            // với khoảng chênh lệch 20% cho tài chính và điểm tiếng Anh
            return allVisaData.filter(visa => {
                // Kiểm tra loại visa
                if (visaType && visa["LOẠI VISA"] !== visaType) return false;

                // Kiểm tra quốc gia
                if (country && visa["NƯỚC DU HỌC"] !== country) return false;

                // Tính khoảng chênh lệch cho tài chính (cho phép thấp hơn 20%)
                const minFinance = parseInt(visa["TÀI CHÍNH PHÙ HỢP TRÊN NĂM"] || 0);
                const minAllowedFinance = minFinance * 0.8; // 80% của yêu cầu
                if (finance < minAllowedFinance) return false;

                // Tính khoảng chênh lệch cho điểm tiếng Anh (cho phép thấp hơn 20%)
                const minEnglishScore = parseInt(visa["ĐIỂM TIẾNG ANH"] || 0);
                const minAllowedEnglishScore = minEnglishScore * 0.8; // 80% của yêu cầu
                if (englishScore < minAllowedEnglishScore) return false;

                // Độ tuổi linh hoạt hơn - cho phép chênh lệch ±2 tuổi
                const ageRanges = visa["ĐỘ TUỔI PHÙ HỢP"]?.split(',').map(a => parseInt(a.trim())) || [];
                if (ageRanges.length > 0) {
                    const isAgeClose = ageRanges.some(validAge => Math.abs(validAge - age) <= 2);
                    if (!isAgeClose) return false;
                }

                return true;
            }).sort((a, b) => {
                // Sắp xếp theo độ phù hợp - visa nào gần với yêu cầu nhất sẽ lên đầu
                const financeA = parseInt(a["TÀI CHÍNH PHÙ HỢP TRÊN NĂM"] || 0);
                const financeB = parseInt(b["TÀI CHÍNH PHÙ HỢP TRÊN NĂM"] || 0);
                const englishA = parseInt(a["ĐIỂM TIẾNG ANH"] || 0);
                const englishB = parseInt(b["ĐIỂM TIẾNG ANH"] || 0);

                // Tính điểm phù hợp (số càng nhỏ càng phù hợp)
                const scoreA = Math.abs(financeA - finance) / finance + Math.abs(englishA - englishScore) / englishScore;
                const scoreB = Math.abs(financeB - finance) / finance + Math.abs(englishB - englishScore) / englishScore;

                return scoreA - scoreB;
            });
        }

        // Hàm để xác thực bước hiện tại - Đã cập nhật để chỉ yêu cầu email HOẶC số điện thoại
        function validateStep(step) {
            let valid = true;
            let fields = [];

            switch (step) {
                case 1:
                    // Kiểm tra tuổi (bắt buộc)
                    if (!document.getElementById('age').checkValidity()) {
                        document.getElementById('age').reportValidity();
                        return false;
                    }

                    // Kiểm tra email HOẶC số điện thoại
                    const email = document.getElementById('email').value.trim();
                    const phone = document.getElementById('phone').value.trim();

                    if (email === '' && phone === '') {
                        alert('Vui lòng nhập email hoặc số điện thoại để liên hệ');
                        return false;
                    }

                    // Nếu có nhập email, kiểm tra định dạng
                    if (email !== '' && !document.getElementById('email').checkValidity()) {
                        document.getElementById('email').reportValidity();
                        return false;
                    }

                    // Nếu có nhập số điện thoại, kiểm tra định dạng
                    if (phone !== '' && !document.getElementById('phone').checkValidity()) {
                        document.getElementById('phone').reportValidity();
                        return false;
                    }
                    break;

                case 2:
                    fields = ['finance', 'englishScore'];
                    break;

                case 3:
                    fields = ['visaType', 'country'];
                    break;
            }

            // Kiểm tra các trường khác nếu có
            for (const field of fields) {
                const element = document.getElementById(field);
                if (!element.checkValidity()) {
                    element.reportValidity();
                    valid = false;
                    break;
                }
            }

            return valid;
        }

        // Hàm cập nhật tóm tắt thông tin
        function updateSummary() {
            // Hiển thị "Không cung cấp" cho các trường không bắt buộc nếu trống
            const fullName = document.getElementById('fullName').value.trim();
            document.getElementById('summaryName').textContent = fullName || "Không cung cấp";

            document.getElementById('summaryAge').textContent = document.getElementById('age').value;

            const email = document.getElementById('email').value.trim();
            document.getElementById('summaryEmail').textContent = email || "Không cung cấp";

            const phone = document.getElementById('phone').value.trim();
            document.getElementById('summaryPhone').textContent = phone || "Không cung cấp";

            document.getElementById('summaryFinance').textContent = parseInt(document.getElementById('finance').value).toLocaleString('vi-VN');
            document.getElementById('summaryEnglish').textContent = document.getElementById('englishScore').value;
            document.getElementById('summaryVisaType').textContent = document.getElementById('visaType').options[document.getElementById('visaType').selectedIndex].text;
            document.getElementById('summaryCountry').textContent = document.getElementById('country').options[document.getElementById('country').selectedIndex].text;
        }

        // Hàm để lấy dữ liệu từ API
        async function fetchVisaData() {
            try {
                const response = await fetch('https://www.appsheet.com/api/v2/apps/8d9567ef-18fc-49cd-8464-aa8bd6dd1f70/tables/Visa/Action', {
                    method: 'POST',
                    headers: {
                        'applicationAccessKey': 'V2-VMoM8-xcbox-cczF1-dGuuQ-1XCTP-yxbUB-cyukd-oXHJY',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "Action": "Find",
                        "Properties": {
                            "Locale": "vi-VN",
                            "Timezone": "Asia/Ho_Chi_Minh"
                        },
                        "Rows": []
                    })
                });

                if (!response.ok) {
                    throw new Error('Lỗi khi lấy dữ liệu visa');
                }

                allVisaData = await response.json();

                // Hiển thị form và ẩn loading
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('progressContainer').classList.remove('hidden');
                document.getElementById('visaForm').classList.remove('hidden');

                // Hiển thị bước đầu tiên
                showStep(1);

                // Điền dữ liệu vào các dropdown
                populateDropdowns();

            } catch (error) {
                console.error('Lỗi:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('errorMessage').classList.remove('hidden');
            }
        }

        // Hàm điền dữ liệu vào các dropdown
        function populateDropdowns() {
            // Lấy các loại visa duy nhất
            // Lấy các loại visa duy nhất
            const visaTypes = [...new Set(allVisaData.map(visa => visa["LOẠI VISA"]))].filter(Boolean).sort();
            const visaTypeSelect = document.getElementById('visaType');

            // Thêm các option vào dropdown loại visa
            visaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                visaTypeSelect.appendChild(option);
            });

            // Lấy các quốc gia duy nhất
            const countries = [...new Set(allVisaData.map(visa => visa["NƯỚC DU HỌC"]))].filter(Boolean).sort();
            const countrySelect = document.getElementById('country');

            // Thêm các option vào dropdown quốc gia
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });
        }

        // Sửa lại hàm lưu dữ liệu khách hàng - không đòi hỏi đầy đủ thông tin
        async function saveCustomerData(suitableVisaIds = "") {
            try {
                const fullName = document.getElementById('fullName').value || "Không cung cấp";
                const age = document.getElementById('age').value;
                const email = document.getElementById('email').value || "Không cung cấp";
                const phone = document.getElementById('phone').value || "Không cung cấp";
                const finance = document.getElementById('finance').value;
                const englishScore = document.getElementById('englishScore').value;

                // Tạo ID duy nhất
                const customerId = 'form_' + Date.now();

                // Không gửi THỜI GIAN, để server tự tạo
                const response = await fetch('https://www.appsheet.com/api/v2/apps/8d9567ef-18fc-49cd-8464-aa8bd6dd1f70/tables/FromVisa/Action', {
                    method: 'POST',
                    headers: {
                        'applicationAccessKey': 'V2-VMoM8-xcbox-cczF1-dGuuQ-1XCTP-yxbUB-cyukd-oXHJY',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "Action": "Add",
                        "Properties": {
                            "Locale": "vi-VN",
                            "Timezone": "Asia/Ho_Chi_Minh"
                        },
                        "Rows": [
                            {
                                "IDFROM": customerId,
                                "HỌ VÀ TÊN": fullName,
                                "Tuổi": age,
                                "Email": email,
                                "Số điện thoại": phone,
                                "TAICHINH": finance,
                                "DIEMTIENGANH": englishScore,
                                "LOẠI VISA PHÙ HỢP": suitableVisaIds
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    console.error('Không thể lưu dữ liệu khách hàng:', await response.text());
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Lỗi khi lưu dữ liệu khách hàng:', error);
                return false;
            }
        }

        // Hàm kiểm tra kết quả chính xác
        function isExactMatch(visa, age, finance, englishScore) {
            // Kiểm tra độ tuổi
            const ageRanges = visa["ĐỘ TUỔI PHÙ HỢP"]?.split(',').map(a => parseInt(a.trim())) || [];
            if (ageRanges.length > 0 && !ageRanges.includes(age)) return false;

            // Kiểm tra tài chính
            const minFinance = parseInt(visa["TÀI CHÍNH PHÙ HỢP TRÊN NĂM"] || 0);
            if (finance < minFinance) return false;

            // Kiểm tra điểm tiếng Anh
            const minEnglishScore = parseInt(visa["ĐIỂM TIẾNG ANH"] || 0);
            if (englishScore < minEnglishScore) return false;

            return true;
        }

        // Xử lý sự kiện chuyển bước
        document.getElementById('nextStep1').addEventListener('click', function () {
            if (validateStep(1)) {
                showStep(2);
            }
        });

        document.getElementById('prevStep2').addEventListener('click', function () {
            showStep(1);
        });

        document.getElementById('nextStep2').addEventListener('click', function () {
            if (validateStep(2)) {
                showStep(3);
            }
        });

        document.getElementById('prevStep3').addEventListener('click', function () {
            showStep(2);
        });

        document.getElementById('nextStep3').addEventListener('click', function () {
            if (validateStep(3)) {
                updateSummary();
                showStep(4);
            }
        });

        document.getElementById('prevStep4').addEventListener('click', function () {
            showStep(3);
        });

        // Xử lý sự kiện submit form
        document.getElementById('visaForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Thêm loading icon vào nút submit
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = `<div class="inline-block animate-spin h-4 w-4 border-t-2 border-b-2 border-white rounded-full mr-2"></div> Đang xử lý...`;

            // Lấy dữ liệu từ form
            const age = parseInt(document.getElementById('age').value);
            const finance = parseInt(document.getElementById('finance').value);
            const englishScore = parseInt(document.getElementById('englishScore').value);
            const visaType = document.getElementById('visaType').value;
            const country = document.getElementById('country').value;

            // Tìm visa phù hợp với khoảng linh hoạt
            const suitableVisas = findSuitableVisas(age, finance, englishScore, visaType, country);

            // Lấy danh sách ID của các visa phù hợp
            let suitableVisaIds = "RỖNG";
            if (suitableVisas.length > 0) {
                suitableVisaIds = suitableVisas.map(visa => visa["IDVISA"]).join(', ');
            }

            // Lưu dữ liệu khách hàng cùng với danh sách ID visa phù hợp
            const savedSuccessfully = await saveCustomerData(suitableVisaIds);

            if (!savedSuccessfully) {
                alert('Có lỗi xảy ra khi lưu thông tin của bạn. Tuy nhiên, chúng tôi vẫn sẽ hiển thị visa phù hợp cho bạn.');
            }

            // Khôi phục nút submit
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;

            // Ẩn form và hiển thị kết quả
            document.getElementById('visaForm').classList.add('hidden');
            document.getElementById('progressContainer').classList.add('hidden');

            // Hiển thị kết quả
            const resultsDiv = document.getElementById('results');
            const visaResultsDiv = document.getElementById('visaResults');

            resultsDiv.classList.remove('hidden');

            if (suitableVisas.length > 0) {
                let resultsHTML = '';

                // Hiển thị thông báo nếu đó là kết quả gần giống
                if (!isExactMatch(suitableVisas[0], age, finance, englishScore)) {
                    resultsHTML += `
                    <div class="mb-5 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 flex items-start">
                        <svg class="w-5 h-5 mr-2 mt-0.5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <p>Không tìm thấy visa phù hợp chính xác. Dưới đây là kết quả gần giống nhất với yêu cầu của bạn.</p>
                    </div>
                `;
                }

                suitableVisas.forEach(visa => {
                    const visaId = visa.IDVISA;
                    const bannerImage = visa["BANER"] ?
                        `<div class="mb-4">
                            <img src="${visa["BANER"]}" alt="${visa["TÊN VISA"]}" class="w-full h-auto rounded-lg shadow-sm object-cover">
                        </div>` : '';

                    // Tính toán độ phù hợp
                    const minFinance = parseInt(visa["TÀI CHÍNH PHÙ HỢP TRÊN NĂM"] || 0);
                    const minEnglishScore = parseInt(visa["ĐIỂM TIẾNG ANH"] || 0);
                    const financeMatch = Math.round((finance / minFinance) * 100);
                    const englishMatch = Math.round((englishScore / minEnglishScore) * 100);

                    // Chuẩn bị thông tin chi tiết nhưng ban đầu ẩn đi
                    const detailsContent = visa["THÔNG TIN CHI TIẾT"] || "Không có thông tin chi tiết";

                    resultsHTML += `
                    <div class="p-5 bg-white rounded-xl shadow-md border border-gray-100 card-hover slide-in">
                        ${bannerImage}
                        <h3 class="text-xl font-bold text-blue-700 mb-2">${visa["TÊN VISA"] || "N/A"}</h3>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${visa["LOẠI VISA"] || "N/A"}
                            </span>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                ${visa["NƯỚC DU HỌC"] || "N/A"}
                            </span>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-sm font-medium text-gray-700">Tài chính của bạn: ${finance.toLocaleString('vi-VN')} VNĐ</p>
                                <p class="text-sm text-gray-600">Yêu cầu tối thiểu: ${minFinance.toLocaleString('vi-VN')} VNĐ</p>
                                <div class="mt-2 h-2.5 w-full bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-2.5 bg-${financeMatch >= 100 ? 'green' : 'yellow'}-500 rounded-full" style="width: ${Math.min(financeMatch, 100)}%"></div>
                                </div>
                                <p class="text-xs text-right mt-1 font-medium ${financeMatch >= 100 ? 'text-green-600' : 'text-yellow-600'}">
                                    ${Math.min(financeMatch, 100)}%
                                </p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-sm font-medium text-gray-700">Điểm tiếng Anh: ${englishScore}</p>
                                <p class="text-sm text-gray-600">Yêu cầu tối thiểu: ${minEnglishScore}</p>
                                <div class="mt-2 h-2.5 w-full bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-2.5 bg-${englishMatch >= 100 ? 'green' : 'yellow'}-500 rounded-full" style="width: ${Math.min(englishMatch, 100)}%"></div>
                                </div>
                                <p class="text-xs text-right mt-1 font-medium ${englishMatch >= 100 ? 'text-green-600' : 'text-yellow-600'}">
                                    ${Math.min(englishMatch, 100)}%
                                </p>
                            </div>
                        </div>
                        
                        <!-- Nút Xem chi tiết -->
                        <div class="mt-4 flex justify-center">
                            <button id="details-btn-${visaId}" onclick="toggleDetails('${visaId}')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-300 w-full sm:w-auto">
                                Xem chi tiết
                            </button>
                        </div>
                        
                        <!-- Nội dung chi tiết - ban đầu ẩn đi -->
                        <div id="details-content-${visaId}" class="content-hidden mt-4 border-t pt-4">
                            <h4 class="font-medium text-gray-800 mb-2">Thông tin chi tiết:</h4>
                            <div class="prose max-w-none text-gray-700">${detailsContent}</div>
                        </div>
                    </div>
                `;
                });

                visaResultsDiv.innerHTML = resultsHTML;

                // Hiển thị nút quay lại sau kết quả
                visaResultsDiv.innerHTML += `
                <div class="text-center mt-8">
                    <button id="restartForm" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 btn-ripple">
                        Quay lại tìm kiếm mới
                    </button>
                </div>
                `;

                // Xử lý sự kiện quay lại
                document.getElementById('restartForm').addEventListener('click', function () {
                    // Reset form
                    document.getElementById('visaForm').reset();

                    // Ẩn kết quả và hiển thị form
                    resultsDiv.classList.add('hidden');
                    document.getElementById('progressContainer').classList.remove('hidden');
                    document.getElementById('visaForm').classList.remove('hidden');

                    // Hiển thị bước đầu tiên
                    showStep(1);
                });
            } else {
                visaResultsDiv.innerHTML = `
                <div class="bg-white rounded-xl shadow-md p-6 text-center border border-red-100">
                    <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="mb-4 text-gray-700">Không tìm thấy visa phù hợp với thông tin của bạn. Vui lòng điều chỉnh các tiêu chí tìm kiếm.</p>
                    <button id="restartForm" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 btn-ripple mt-2">
                        Quay lại tìm kiếm mới
                    </button>
                </div>
                `;

                // Xử lý sự kiện quay lại
                document.getElementById('restartForm').addEventListener('click', function () {
                    // Reset form
                    document.getElementById('visaForm').reset();

                    // Ẩn kết quả và hiển thị form
                    resultsDiv.classList.add('hidden');
                    document.getElementById('progressContainer').classList.remove('hidden');
                    document.getElementById('visaForm').classList.remove('hidden');

                    // Hiển thị bước đầu tiên
                    showStep(1);
                });
            }
        });

        // Bắt sự kiện nhấn phím Enter
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();

                // Xác định nút tiếp theo dựa vào bước hiện tại
                switch (currentStep) {
                    case 1:
                        document.getElementById('nextStep1').click();
                        break;
                    case 2:
                        document.getElementById('nextStep2').click();
                        break;
                    case 3:
                        document.getElementById('nextStep3').click();
                        break;
                    case 4:
                        // Submit form khi ở bước cuối cùng
                        document.querySelector('button[type="submit"]').click();
                        break;
                }
            }
        });

        // Thêm hàm toggle chi tiết vào global scope để có thể gọi từ onclick
        window.toggleDetails = toggleDetails;

        window.addEventListener('DOMContentLoaded', fetchVisaData);
    </script>
</body>

</html>
